
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Strategies &#8212; Blue Sky Workflow Engine  documentation</title>
    <link rel="stylesheet" href="_static/aibs_sphinx.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Configuration Objects" href="configurations.html" />
    <link rel="prev" title="Workflows" href="workflows.html" /> 
  </head>
  <body>
<link href="http://www.brain-map.org/assets/stylesheets/portal.css" media="screen" rel="stylesheet" type="text/css" />
<script src="http://www.brain-map.org/assets/javascripts/portal.js" type="text/javascript"></script>
<script src="http://www.brain-map.org/assets/javascripts/ga.js" type="text/javascript"></script>
<script type="text/javascript">
    var _pSupressBrowserFlashWarning = true;
    var _pTabId = "pHome";
    var _pMoreProjectsId = "pMoreProjects";
    var _pImagePath = "http://www.brain-map.org/assets/images/";
    var _pSiteWarnings = function() {
        this.show_warning() = {};
    }
</script>
<script type="text/javascript">
    function initialize() {
        /*** do your stuff, then initialize the portal plugin ***/
        _pPortalOnLoad();
    }
</script>
<style>
  #header_content > a {
  display: inline-block;
  width: 250px;
  height: 75px;
  background-image:url("/_static/external_assets/images/Brain_Atlas_Logotype_SDK.png") !important;
  background-size: 235px 37px;
  background-position: 0px 20px;
  background-repeat: no-repeat;
  }
</style>

<script type="text/javascript" src="http://www.brain-map.org/external_assets/javascripts/portalHeader.js"></script>
<link rel="stylesheet" type="text/css" href="/_static/external_assets/stylesheets/common_layout.css" />


  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="strategies">
<h1>Strategies<a class="headerlink" href="#strategies" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="execution-strategies">
<h2>Execution Strategies<a class="headerlink" href="#execution-strategies" title="Permalink to this headline">¶</a></h2>
<p>Execution strategies query the model based on the enqueued object.
They create an input JSON file from a template configuration
and the query results. They then create a PBS script, read the output json
and then store the results in the database and configuration objects.</p>
<p>A simple execution strategy can build an input.json from three sources.
The basic template can come from a Configuration object stored in the
database and associated with the strategies workflow node.
It can also be filtered by name and configuration_type as shown below.
The json template can then be filled in based on the settings object,
which is useful for values that vary by deployment.
Most often, additional values will come from
the enqueued object and its associated models.</p>
<p>The on_finishing method can check the output json, raise exceptions in the case of an unexpected or failed result, and update the enqueued object in the database</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">workflow_engine.strategies.execution_strategy</span> <span class="kn">import</span> <span class="n">ExecutionStrategy</span>
<span class="kn">from</span> <span class="nn">workflow_engine.models.configuration</span> <span class="kn">import</span> <span class="n">Configuration</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="k">class</span> <span class="nc">ExampleStrategy</span><span class="p">(</span><span class="n">ExecutionStrategy</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observation</span><span class="p">,</span> <span class="n">storage_directory</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
        <span class="n">strategy_configuration</span> <span class="o">=</span> \
            <span class="n">Configuration</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Apply Lens Correction Input&#39;</span><span class="p">,</span>
                <span class="n">configuration_type</span><span class="o">=</span><span class="s1">&#39;strategy_config&#39;</span><span class="p">)</span>
        <span class="c1"># input.json template from database</span>
        <span class="n">inp</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">strategy_configuration</span><span class="o">.</span><span class="n">json_object</span><span class="p">)</span>

        <span class="n">inp</span><span class="p">[</span><span class="s1">&#39;arg1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">ARG_1</span>  <span class="c1"># from django settings</span>
        <span class="n">inp</span><span class="p">[</span><span class="s1">&#39;arg2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">observation</span><span class="o">.</span><span class="n">measurement</span> <span class="c1"># from enqueued object</span>

        <span class="k">return</span> <span class="n">inp</span>

    <span class="k">def</span> <span class="nf">on_finishing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observation</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_key</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="s1">&#39;result_value&#39;</span><span class="p">)</span>
        <span class="n">observation</span><span class="o">.</span><span class="n">measurement</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;result_value&#39;</span><span class="p">]</span>
        <span class="n">observation</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<div class="section" id="wait-strategies">
<h3>Wait Strategies<a class="headerlink" href="#wait-strategies" title="Permalink to this headline">¶</a></h3>
<p>Wait strategies are used to hold an object unless and until an external
condition is met. They inherit from WaitStrategy and implement must_wait.
These can be used to hold an enqueued object for a manual quality control step
or to implement a barrier to wait for other objects to complete processing
before proceeding with following job queues. Note that wait strategy workflow
nodes usually have a mock executable as a place holder.
You can <a class="reference external" href="https://docs.djangoproject.com/en/1.11/ref/contrib/admin/actions/">add functionality to the admin UI</a>
to allow the user to set or modify the state of a group of objects.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">workflow_engine.strategies.wait_strategy</span> <span class="kn">import</span> <span class="n">WaitStrategy</span>

<span class="k">class</span> <span class="nc">WaitForLensCorrection</span><span class="p">(</span><span class="n">WaitStrategy</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">must_wait</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observation</span><span class="p">):</span>
        <span class="c1"># Use this to check if the reference set is available</span>
        <span class="c1"># return true if the state is correct</span>
        <span class="n">manual_setting</span> <span class="o">=</span> <span class="n">observation</span><span class="o">.</span><span class="n">manual_setting</span>

        <span class="k">if</span> <span class="n">manual_setting</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>

        <span class="k">return</span> <span class="bp">False</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="ingest-strategies">
<h2>Ingest Strategies<a class="headerlink" href="#ingest-strategies" title="Permalink to this headline">¶</a></h2>
<p>An ingest strategy is used to create or update an object from an external
message source. It is usually the first strategy in a workflow.
An ingest strategy does not run an executable module.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">workflow_engine.strategies.ingest_strategy</span> <span class="kn">import</span> <span class="n">IngestStrategy</span>
<span class="kn">from</span> <span class="nn">blue_sky.models.observation</span> <span class="kn">import</span> <span class="n">Observation</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="k">class</span> <span class="nc">MockIngest</span><span class="p">(</span><span class="n">IngestStrategy</span><span class="p">):</span>
    <span class="n">_log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;blue-sky.mock_ingest&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_workflow_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;mock_workflow&#39;</span>

    <span class="k">def</span> <span class="nf">create_enqueued_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">Observation</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">update_or_create</span><span class="p">(</span>
            <span class="n">arg1</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="s1">&#39;arg1&#39;</span><span class="p">],</span>
            <span class="n">arg2</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="s1">&#39;arg2&#39;</span><span class="p">],</span>
            <span class="n">arg3</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="s1">&#39;arg3&#39;</span><span class="p">],</span>
            <span class="n">defaults</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;proc_state&#39;</span><span class="p">:</span> <span class="s1">&#39;PENDING&#39;</span>
            <span class="p">})</span>

        <span class="k">return</span> <span class="n">obs</span><span class="p">,</span> <span class="bp">None</span>


    <span class="k">def</span> <span class="nf">generate_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observation</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;observation_id&#39;</span><span class="p">:</span> <span class="n">observation</span><span class="o">.</span><span class="n">id</span>
        <span class="p">}</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="index.html">Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="install.html">Install Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="settings.html">Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="customizing.html">Customization</a></li>
<li class="toctree-l1"><a class="reference internal" href="workflows.html">Workflows</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Strategies</a></li>
<li class="toctree-l1"><a class="reference internal" href="configurations.html">Configuration Objects</a></li>
<li class="toctree-l1"><a class="reference internal" href="develop.html">Developers Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="workflow_engine.html">Source Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="workflow_engine.admin.html">workflow_engine.admin package</a></li>
<li class="toctree-l2"><a class="reference internal" href="workflow_engine.celery.html">workflow_engine.celery package</a></li>
<li class="toctree-l2"><a class="reference internal" href="workflow_engine.migrations.html">workflow_engine.migrations package</a></li>
<li class="toctree-l2"><a class="reference internal" href="workflow_engine.mixins.html">workflow_engine.mixins package</a></li>
<li class="toctree-l2"><a class="reference internal" href="workflow_engine.models.html">workflow_engine.models package</a></li>
<li class="toctree-l2"><a class="reference internal" href="workflow_engine.serializers.html">workflow_engine.serializers package</a></li>
<li class="toctree-l2"><a class="reference internal" href="workflow_engine.strategies.html">workflow_engine.strategies package</a></li>
<li class="toctree-l2"><a class="reference internal" href="workflow_engine.views.html">workflow_engine.views package</a></li>
<li class="toctree-l2"><a class="reference internal" href="workflow_engine.worker.html">workflow_engine.worker package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="workflow_engine.worker.qsub.html">workflow_engine.worker.qsub package</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="workflow_client.html">Client Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="workflow_client.ingest.html">workflow_client.ingest package</a></li>
<li class="toctree-l2"><a class="reference internal" href="workflow_client.nb_utils.html">workflow_client.nb_utils package</a></li>
<li class="toctree-l2"><a class="reference internal" href="workflow_client.tasks.html">workflow_client.tasks package</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/AllenInstitute/BlueSkyWorkflowEngine">Github Profile</a></li>
</ul>

<h3> Questions </h3>
<p class="questions">
  Send any questions using the <a href="http://alleninstitute.org/contact_us/index.html">Send Us a Message</a> link below, 
  or submit your question to <a href="http://stackoverflow.com/">StackOverflow</a> using with the 'allen-sdk' tag.
</p>

<p class="questions">
  If you encounter any problems using the AllenSDK, please create an issue on <a href="http://github.com/alleninstitute/allensdk/issues/">Github's issue tracker</a>.
</p>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>


    <div class="footer" role="contentinfo">
    </div>
<script type="text/javascript" src="http://www.brain-map.org/external_assets/javascripts/portalFooter.js"></script>


  </body>
</html>